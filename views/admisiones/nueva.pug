extends ../layout

block content
  .row.justify-content-center
    .col-lg-10.col-xl-9
      .card.shadow-sm.my-4
        .card-header
          h1.h4.mb-0 Registrar Nueva Admisión
        .card-body.p-4
          form(action="/admisiones", method="POST")
            .card.mb-4
              .card-header.fw-bold Datos del Paciente
              .card-body
                .row.align-items-end
                  .col-md-8.mb-3.mb-md-0
                    label.form-label(for="pacienteSelector") Seleccionar Paciente Existente
                    select.form-select#pacienteSelector(name="id_paciente_seleccionado", required)
                      option(value="") -- Seleccionar paciente --
                      option(value="nuevo") -- Registrar Nuevo Paciente --
                      each p in pacientes
                        option(value=p.id_paciente)= p.nombre + ' ' + p.apellido + ' (DNI: ' + p.dni + ')'
                  .col-md-4.d-flex.align-items-center.justify-content-start.justify-content-md-end.pb-1
                    .form-check.form-switch
                      input.form-check-input#es_emergencia(type="checkbox", name="es_emergencia")
                      label.form-check-label.fw-bold.text-danger(for="es_emergencia") Emergencia
            
            #nuevoPacienteFields.card.mb-4(style="display: none;")
              .card-header.fw-bold Información del Nuevo Paciente
              .card-body
                .row.g-3
                  .col-md-6: .form-floating
                    input.form-control#nombre_paciente_nuevo(type="text", name="nombre_paciente_nuevo", placeholder="Nombre")
                    label(for="nombre_paciente_nuevo") Nombre
                  .col-md-6: .form-floating
                    input.form-control#apellido_paciente_nuevo(type="text", name="apellido_paciente_nuevo", placeholder="Apellido")
                    label(for="apellido_paciente_nuevo") Apellido
                  .col-md-6: .form-floating
                    input.form-control#dni_paciente_nuevo(type="text", name="dni_paciente_nuevo", placeholder="DNI")
                    label(for="dni_paciente_nuevo") DNI
                  .col-md-6
                    label.form-label(for="fecha_nacimiento_nuevo") Fecha de Nacimiento
                    input.form-control#fecha_nacimiento_nuevo(type="date", name="fecha_nacimiento_nuevo")
                  .col-md-6
                    label.form-label(for="genero_paciente_nuevo") Género
                    select.form-select#genero_paciente_nuevo(name="genero_paciente_nuevo")
                      option(value="") Seleccionar Género
                      option(value="Masculino") Masculino
                      option(value="Femenino") Femenino
                      option(value="Otro") Otro
                      option(value="No especificado") No especificado
                  .col-md-6: .form-floating
                    input.form-control#telefono_nuevo(type="text", name="telefono_nuevo", placeholder="Teléfono")
                    label(for="telefono_nuevo") Teléfono
                  .col-md-6: .form-floating
                    input.form-control#email_nuevo(type="email", name="email_nuevo", placeholder="Email")
                    label(for="email_nuevo") Email
                  .col-md-6: .form-floating
                    input.form-control#direccion_nuevo(type="text", name="direccion_nuevo", placeholder="Dirección")
                    label(for="direccion_nuevo") Dirección
                  .col-md-6
                    label.form-label(for="grupo_sanguineo_nuevo") Grupo Sanguíneo
                    select.form-select#grupo_sanguineo_nuevo(name="grupo_sanguineo_nuevo")
                      option(value="") Seleccionar
                      option(value="A+") A+
                      option(value="A-") A-
                      option(value="B+") B+
                      option(value="B-") B-
                      option(value="AB+") AB+
                      option(value="AB-") AB-
                      option(value="O+") O+
                      option(value="O-") O-
                  .col-md-6: .form-floating
                    textarea.form-control#alergias_nuevo(name="alergias_nuevo", placeholder="Alergias", style="height: 100px")
                    label(for="alergias_nuevo") Alergias
                  .col-md-6: .form-floating
                    textarea.form-control#medicamentos_nuevo(name="medicamentos_nuevo", placeholder="Medicamentos Actuales", style="height: 100px")
                    label(for="medicamentos_nuevo") Medicamentos Actuales
                  .col-md-6
                    label.form-label(for="id_obra_social_nuevo") Obra Social
                    select.form-select#id_obra_social_nuevo(name="id_obra_social_nuevo")
                      option(value="") Seleccionar Obra Social
                      each os in obrasSociales
                        option(value=os.id_obra_social)= os.nombre
                  .col-md-6: .form-floating
                    input.form-control#numero_afiliado_nuevo(type="text", name="numero_afiliado_nuevo", placeholder="Número de Afiliado")
                    label(for="numero_afiliado_nuevo") Número de Afiliado

            .card.mb-4
              .card-header.fw-bold Detalles de la Admisión
              .card-body
                .row.g-3
                  .col-md-6
                    label.form-label(for="fecha_ingreso") Fecha de Ingreso
                    input.form-control#fecha_ingreso(type="datetime-local", name="fecha_ingreso", value=new Date().toISOString().slice(0, 16), required)
                  .col-md-12
                    label.form-label(for="motivo_internacion") Motivo de Internación
                    textarea.form-control#motivo_internacion(name="motivo_internacion", placeholder="Describa el motivo de la internación", required, rows="3")

            .card.mb-4
              .card-header.fw-bold Asignación de Cama
              .card-body
                label.form-label(for="id_cama_asignada") Cama Disponible
                select.form-select#id_cama_asignada(name="id_cama_asignada", required)
                  option(value="") -- Seleccione una cama disponible --
                  each cama in camasDisponibles
                    option(value=cama.id_cama)= `Hab: ${cama.habitacion.numero} (Ala: ${cama.habitacion.ala.nombre}) - Cama: ${cama.numero} ${cama.genero_asignado ? '(Género: ' + (cama.genero_asignado === 'M' ? 'Masculino' : 'Femenino') + ')' : '(Mixto/Individual)'}`
            
            .d-flex.justify-content-end
              button.btn.btn-primary.btn-lg(type="submit") Guardar Admisión

block scripts append
  script.
    const pacienteSelector = document.getElementById('pacienteSelector');
    const nuevoPacienteFields = document.getElementById('nuevoPacienteFields');
    const esEmergenciaCheckbox = document.getElementById('es_emergencia');

    const nuevoPacienteInputs = nuevoPacienteFields.querySelectorAll('input, select, textarea');

    function toggleNuevoPacienteFields() {
      const isNuevoPacienteSelected = pacienteSelector.value === 'nuevo';
      const isEmergenciaChecked = esEmergenciaCheckbox.checked;

      const shouldShow = isNuevoPacienteSelected || isEmergenciaChecked;
      
      nuevoPacienteFields.style.display = shouldShow ? 'block' : 'none';

      nuevoPacienteInputs.forEach(input => {
        let isRequired = false;
        if (shouldShow) {
          const requiredForNew = ['nombre_paciente_nuevo', 'apellido_paciente_nuevo', 'dni_paciente_nuevo', 'genero_paciente_nuevo'];
          if (requiredForNew.includes(input.name)) {
            isRequired = isNuevoPacienteSelected || isEmergenciaChecked;
          }
        }
        input.required = isRequired;
      });
      
      pacienteSelector.required = !shouldShow;
    }

    pacienteSelector.addEventListener('change', toggleNuevoPacienteFields);
    esEmergenciaCheckbox.addEventListener('change', toggleNuevoPacienteFields);
    document.addEventListener('DOMContentLoaded', toggleNuevoPacienteFields);